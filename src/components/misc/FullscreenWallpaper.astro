---
import { siteConfig } from "../../config";
import type { FullscreenWallpaperConfig } from "../../types/config";

interface Props {
	config: FullscreenWallpaperConfig;
	className?: string;
}

const { config, className } = Astro.props;

// 获取当前设备类型的图片源
const getImageSources = async () => {
	let srcConfig = config.src;

	// 如果启用了图片API，使用API图片
	if (
		siteConfig.banner.imageApi?.enable &&
		siteConfig.banner.imageApi?.url
	) {
		try {
			const response = await fetch(siteConfig.banner.imageApi.url);
			const text = await response.text();
			const apiImages = text.split("\n").filter((line) => line.trim());

			if (apiImages.length > 0) {
				// 将API图片同时用于桌面端和移动端
				return {
					desktop: apiImages,
					mobile: apiImages,
				};
			}
		} catch (error) {
			console.warn("Failed to fetch images from API for wallpaper:", error);
		}
	}
	const toArray = (src: string | string[] | undefined): string[] => {
		if (Array.isArray(src)) return src;
		if (typeof src === "string") return [src];
		return [];
	};
	
	if (
		typeof srcConfig === "object" &&
		srcConfig !== null &&
		!Array.isArray(srcConfig) &&
		("desktop" in srcConfig || "mobile" in srcConfig)
	) {
		const srcObj = srcConfig as {
			desktop?: string | string[];
			mobile?: string | string[];
		};
		const desktop = toArray(srcObj.desktop);
		const mobile = toArray(srcObj.mobile);
		return {
			desktop: desktop.length > 0 ? desktop : mobile,
			mobile: mobile.length > 0 ? mobile : desktop,
		};
	}
	
	const allImages = toArray(srcConfig as string | string[]);
	return {
		desktop: allImages,
		mobile: allImages,
	};
};

const imageSources = await getImageSources();
const hasDesktopImages = imageSources.desktop.length > 0;
const hasMobileImages = imageSources.mobile.length > 0;

// 如果没有任何图片源，不渲染
if (!hasDesktopImages && !hasMobileImages) {
	return null;
}

// 轮播相关逻辑
const isCarouselEnabled =
	config.carousel?.enable &&
	(imageSources.desktop.length > 1 || imageSources.mobile.length > 1);
const carouselInterval = config.carousel?.interval || 5;

// 随机选择图片（关键修改：不轮播时只随机选一张）
let desktopImagesToShow = imageSources.desktop;
let mobileImagesToShow = imageSources.mobile;

if (!isCarouselEnabled) {
	// 随机选择一张桌面图片
	if (hasDesktopImages) {
		const randomIndex = Math.floor(Math.random() * imageSources.desktop.length);
		desktopImagesToShow = [imageSources.desktop[randomIndex]];
	}
	// 随机选择一张移动图片
	if (hasMobileImages) {
		const randomIndex = Math.floor(Math.random() * imageSources.mobile.length);
		mobileImagesToShow = [imageSources.mobile[randomIndex]];
	}
}

// 样式相关
const position = config.position || "center";
const zIndex = config.zIndex || -1;
const opacity = config.opacity || 0.8;
const blur = config.blur || 0;

// 生成位置类名
const getPositionClass = (pos: string) => {
	switch (pos) {
		case "top":
			return "object-top";
		case "bottom":
			return "object-bottom";
		default:
			return "object-center";
	}
};

const positionClass = getPositionClass(position);
---

<div 
	class:list={[
		"fixed inset-0 w-full h-full overflow-hidden pointer-events-none",
		className
	]}
	style={`z-index: ${zIndex}; opacity: ${opacity};`}
	data-fullscreen-wallpaper
>
<script is:inline>
// 根据 localStorage 立即设置全屏壁纸初始显示状态，避免闪烁
(function() {
	const wallpaperMode = localStorage.getItem('wallpaperMode') || 'banner';
	const fullscreenWallpaper = document.currentScript.parentElement;
	if (wallpaperMode !== 'fullscreen') {
		fullscreenWallpaper.style.display = 'none';
	}
})();
</script>
	<!-- 桌面端壁纸 -->
	{hasDesktopImages && (
		<div class="hidden lg:block w-full h-full relative">
			{desktopImagesToShow.map((src, index) => {
				const imageClass = `absolute inset-0 w-full h-full object-cover ${positionClass}`;
				return (
					<img
						src={src}
						alt={`Desktop wallpaper ${index + 1}`}
						class={imageClass}
						style={blur > 0 ? `filter: blur(${blur}px);` : undefined}
					/>
				);
			})}
		</div>
	)}

	<!-- 移动端壁纸 -->
	{hasMobileImages && (
		<div class="block lg:hidden w-full h-full relative">
			{mobileImagesToShow.map((src, index) => {
				const imageClass = `absolute inset-0 w-full h-full object-cover ${positionClass}`;
				return (
					<img
						src={src}
						alt={`Mobile wallpaper ${index + 1}`}
						class={imageClass}
						style={blur > 0 ? `filter: blur(${blur}px);` : undefined}
					/>
				);
			})}
		</div>
	)}
</div>

{isCarouselEnabled && (
	<script define:vars={{ carouselInterval }}>
		// 全屏壁纸轮播逻辑
		function initFullscreenWallpaperCarousel() {
			const wallpaperContainer = document.querySelector('[data-fullscreen-wallpaper]');
			if (!wallpaperContainer) return;

			const desktopItems = wallpaperContainer.querySelectorAll('.hidden.lg\\:block [data-carousel-item]');
			const mobileItems = wallpaperContainer.querySelectorAll('.block.lg\\:hidden [data-carousel-item]');

			function startCarousel(items) {
				if (items.length <= 1) return;

				let currentIndex = 0;
				
				// 初始化：显示第一张，隐藏其他
				items.forEach((item, index) => {
					item.style.opacity = index === 0 ? '1' : '0';
				});

				// 开始轮播
				setInterval(() => {
					items[currentIndex].style.opacity = '0';
					currentIndex = (currentIndex + 1) % items.length;
					items[currentIndex].style.opacity = '1';
				}, carouselInterval * 1000);
			}

			if (desktopItems.length > 0) startCarousel(desktopItems);
			if (mobileItems.length > 0) startCarousel(mobileItems);
		}

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initFullscreenWallpaperCarousel);
		} else {
			initFullscreenWallpaperCarousel();
		}
	</script>
)}