---
import { Icon } from "astro-icon/components";
import { siteConfig } from "../../config";

const tocDepth = siteConfig.toc.depth;
const useJapaneseBadge = siteConfig.toc.useJapaneseBadge;
---

<div class="floating-toc-wrapper" data-depth={tocDepth} data-japanese-badge={useJapaneseBadge}>
    <button id="floating-toc-btn" class="floating-toc-btn btn-card" aria-label="Table of Contents">
        <Icon name="material-symbols:format-list-bulleted-rounded" class="text-2xl" />
    </button>
    <div id="floating-toc-panel" class="floating-toc-panel">
        <div class="floating-toc-panel-content" id="floating-toc-content">
            <!-- TOC items will be generated by JavaScript -->
        </div>
    </div>
</div>

<style>
    .floating-toc-wrapper {
        position: fixed;
        right: 6rem;
        bottom: 14rem;
        z-index: 50;
        pointer-events: auto;
        transform: translateX(5rem);
    }

    .floating-toc-btn {
        width: 3.75rem;
        height: 3.75rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
    }

    .floating-toc-btn.active {
        background: var(--btn-card-bg-active);
    }

    .floating-toc-panel {
        position: absolute;
        bottom: 4rem;
        right: 0;
        width: 18rem;
        max-height: 60vh;
        background: var(--card-bg);
        border: 1px solid var(--line-color);
        border-radius: 1rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px) scale(0.95);
        transition: all 0.2s ease;
        pointer-events: none;
    }

    .floating-toc-panel.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
        pointer-events: auto;
    }

    .floating-toc-panel-content {
        padding: 0.75rem;
        max-height: 60vh;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .floating-toc-panel-content::-webkit-scrollbar {
        width: 4px;
    }

    .floating-toc-panel-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .floating-toc-panel-content::-webkit-scrollbar-thumb {
        background: var(--line-color);
        border-radius: 2px;
    }

    .floating-toc-wrapper.no-toc {
        display: none;
    }

    /* 当前章节高亮 */
    :global(.floating-toc-item.active) {
        background: var(--btn-regular-bg);
        border-radius: 0.5rem;
    }

    :global(.floating-toc-item.active .floating-toc-text) {
        color: var(--primary);
        font-weight: 500;
    }

    /* 移动端隐藏，使用顶栏的MobileTOC */
    @media (max-width: 1024px) {
        .floating-toc-wrapper {
            display: none;
        }
    }

    @media (max-width: 1560px) {
        .floating-toc-wrapper {
            box-shadow: 0 0 0 1px var(--btn-regular-bg), 0 0 1em var(--btn-regular-bg);
            border-radius: 1rem;
        }
    }
</style>

<script>
class FloatingTOC {
    private btn: HTMLElement | null;
    private panel: HTMLElement | null;
    private content: HTMLElement | null;
    private wrapper: HTMLElement | null;
    private isOpen = false;
    /** 自动展开的滚动阈值（px） */
    private scrollThreshold = 240;
    /** 是否已经自动展开过（只触发一次） */
    private autoOpened = false;
    /** 页面进入时间，用于“克制式”延迟判断 */
    private enterTime = Date.now();
    /** 停留多久后才允许自动展开（ms） */
    private delayMs = 1200;
    /** IntersectionObserver 实例（用于章节高亮） */
    private observer?: IntersectionObserver;
    /** 当前高亮的标题 id */
    private activeId: string | null = null;

    constructor() {
        this.btn = document.getElementById('floating-toc-btn');
        this.panel = document.getElementById('floating-toc-panel');
        this.content = document.getElementById('floating-toc-content');
        this.wrapper = document.querySelector('.floating-toc-wrapper');
        
        this.init();
    }

    private init() {
        this.generateTOC();
        this.observeHeadings();
        this.bindEvents();
    }

    private generateTOC() {
        const headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
        
        if (headings.length === 0) {
            this.wrapper?.classList.add('no-toc');
            return;
        }

        this.wrapper?.classList.remove('no-toc');

        const maxLevel = parseInt(this.wrapper?.dataset.depth || '3');
        const useJapaneseBadge = this.wrapper?.dataset.japaneseBadge === 'true';

        const japaneseKatakana = [
            "ア", "イ", "ウ", "エ", "オ", "カ", "キ", "ク", "ケ", "コ",
            "サ", "シ", "ス", "セ", "ソ", "タ", "チ", "ツ", "テ", "ト",
            "ナ", "ニ", "ヌ", "ネ", "ノ", "ハ", "ヒ", "フ", "ヘ", "ホ"
        ];

        let minLevel = 6;
        headings.forEach(h => {
            const level = parseInt(h.tagName[1]);
            if (level < minLevel) minLevel = level;
        });

        let html = '';
        let h1Count = 0;

        headings.forEach(heading => {
            const level = parseInt(heading.tagName[1]);
            if (level >= minLevel + maxLevel) return;

            const indent = (level - minLevel) * 1;
            let badge = '';

            if (level === minLevel) {
                h1Count++;
                const badgeText = useJapaneseBadge && h1Count - 1 < japaneseKatakana.length
                    ? japaneseKatakana[h1Count - 1]
                    : h1Count.toString();
                badge = `<span class="floating-toc-badge">${badgeText}</span>`;
            } else if (level === minLevel + 1) {
                badge = '<span class="floating-toc-dot"></span>';
            } else {
                badge = '<span class="floating-toc-dot-small"></span>';
            }

            const text = (heading.textContent || '').replace(/#+\s*$/, '');
            html += `<a href="#${heading.id}" class="floating-toc-item" style="padding-left: ${0.5 + indent}rem" data-level="${level - minLevel}">${badge}<span class="floating-toc-text">${text}</span></a>`;
        });

        if (this.content) {
            this.content.innerHTML = html;
        }
    }

    private bindEvents() {
        // 滚动触发自动展开（只触发一次）
        window.addEventListener('scroll', () => {
            if (this.autoOpened || this.isOpen) return;
            // 没滚够，不考虑
            if (window.scrollY < this.scrollThreshold) return;
            // 停留时间不够，不考虑
            if (Date.now() - this.enterTime < this.delayMs) return;

            this.autoOpened = true;
            this.open();
        });


        this.btn?.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggle();
        });

        // 点击目录外面，关闭目录
        // document.addEventListener('click', (e) => {
        //     if (this.isOpen && !this.wrapper?.contains(e.target as Node)) {
        //         this.close();
        //     }
        // });

        this.content?.addEventListener('click', (e) => {
            const link = (e.target as HTMLElement).closest('a');
            if (link) {
                e.preventDefault();
                const id = link.getAttribute('href')?.slice(1);
                if (id) {
                    const element = document.getElementById(id);
                    if (element) {
                        const top = element.getBoundingClientRect().top + window.scrollY - 80;
                        window.scrollTo({ top, behavior: 'smooth' });
                        // 跳转不关闭目录
                        // this.close();
                    }
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isOpen) this.close();
        });

        if ((window as any).swup) {
            (window as any).swup.hooks.on('page:view', () => {
                setTimeout(() => this.reinit(), 200);
            });
        }
    }

    private toggle() {
        this.isOpen ? this.close() : this.open();
    }

    private open() {
        this.isOpen = true;
        this.panel?.classList.add('show');
        this.btn?.classList.add('active');
    }

    private close() {
        this.isOpen = false;
        this.panel?.classList.remove('show');
        this.btn?.classList.remove('active');
    }

    private reinit() {
        this.close();
        this.generateTOC();
        this.observeHeadings();
    }

    /**
     * 使用 IntersectionObserver 监听文章标题
     * 用于：
     * - 当前章节高亮
     * - 自动滚动 TOC
     */
    private observeHeadings() {
        const headings = Array.from(
            document.querySelectorAll<HTMLElement>('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]')
        );

        if (!headings.length) return;

        this.observer?.disconnect();

        this.observer = new IntersectionObserver(
            (entries) => {
                // 只处理正在进入视口的标题
                const visible = entries
                    .filter(e => e.isIntersecting)
                    .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

                if (!visible.length) return;

                const id = visible[0].target.id;
                if (id !== this.activeId) {
                    this.activeId = id;
                    this.setActiveItem(id);
                }
            },
            {
                root: null,
                rootMargin: '-80px 0px -60% 0px',
                threshold: 0,
            }
        );

        headings.forEach(h => this.observer!.observe(h));
    }

    /**
     * 设置 TOC 当前高亮项
     * 并在必要时滚动 TOC 内容区（克制）
     */
    private setActiveItem(id: string) {
        if (!this.content) return;

        const items = this.content.querySelectorAll<HTMLElement>('.floating-toc-item');
        let activeItem: HTMLElement | null = null;

        items.forEach(item => {
            const href = item.getAttribute('href')?.slice(1);
            const isActive = href === id;
            item.classList.toggle('active', isActive);
            if (isActive) activeItem = item;
        });

        // 自动滚动 TOC（克制）
        if (activeItem) {
            const domElement = activeItem as HTMLElement;
            domElement.scrollIntoView({
                block: 'center',
                inline: 'nearest',
                behavior: 'smooth',
            });
        }
    }
}

document.addEventListener('DOMContentLoaded', () => new FloatingTOC());
document.addEventListener('swup:page:view', () => new FloatingTOC());
</script>
